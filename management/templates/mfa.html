<style>
    .twofactor #totp-setup,
    .twofactor #disable-2fa,
    .twofactor #output-2fa {
        display: none;
    }

    .twofactor.loaded .loading-indicator {
        display: none;
    }

    .twofactor.disabled #disable-2fa,
    .twofactor.enabled #totp-setup {
        display: none;
    }

    .twofactor.disabled #totp-setup,
    .twofactor.enabled #disable-2fa {
        display: block;
    }

    .twofactor #totp-setup-qr img {
        display: block;
        width: 256px;
        max-width: 100%;
        height: auto;
    }

    .twofactor #output-2fa.visible {
        display: block;
    }
</style>


<h2>Двухфакторная аутентификация</h2>

<p>Когда включена двухфакторная аутентификация, при входе в панель управления вам будет предложено ввести шестизначный код
из приложения-аутентификатора (обычно на телефоне).</p>

<div class="panel panel-danger">
<div class="panel-heading">
Включение двухфакторной аутентификации не защищает доступ к вашей почте
</div>
<div class="panel-body">
Включение двухфакторной аутентификации на этой странице ограничивает доступ только к панели управления. Помните, что большинство сайтов
позволяют сбросить пароль через электронную почту — поэтому любой, у кого есть доступ к вашей почте, обычно сможет получить контроль
над другими вашими аккаунтами. Кроме того, если ваш адрес электронной почты или любой алиас, пересылающий почту на ваш адрес,
является типичным адресом для подтверждения владения доменом (например admin@, administrator@, postmaster@, hostmaster@,
webmaster@, abuse@), необходимо проявлять повышенную осторожность при защите такой учётной записи. <strong>Всегда используйте
надёжный пароль и убедитесь, что каждая учётная запись администратора панели делает то же самое.</strong>
</div>
</div>

<div class="twofactor">
    <div class="loading-indicator">Загрузка...</div>

    <form id="totp-setup">
    <h3>Инструкции по настройке</h3>

        <div class="form-group">
            <p>1. Установите <a href="https://freeotp.github.io/">FreeOTP</a> или <a href="https://www.pcworld.com/article/3225913/what-is-two-factor-authentication-and-which-2fa-apps-are-best.html">любое другое приложение двухфакторной аутентификации</a>, поддерживающее TOTP.</p>
        </div>

        <div class="form-group">
            <p style="margin-bottom: 0">2. Сканируйте QR‑код в приложении или введите секрет вручную:</p>
            <div id="totp-setup-qr"></div>
        </div>

        <div class="form-group">
            <label for="otp-label" style="font-weight: normal">3. По желанию укажите метку для устройства, чтобы помнить, на каком устройстве вы настроили аутентификатор:</label>
            <input type="text" id="totp-setup-label" class="form-control" placeholder="мой телефон" />
        </div>

        <div class="form-group">
            <label for="otp" style="font-weight: normal">4. С помощью приложения сгенерируйте первый шестизначный код и введите его здесь:</label>
            <input type="text" id="totp-setup-token" class="form-control" placeholder="6-значный код" />
        </div>

        <input type="hidden" id="totp-setup-secret" />

        <div class="form-group">
            <p>После нажатия «Включить двухфакторную аутентификацию» вы будете выведены из панели управления и вам потребуется войти снова, используя приложение двухфакторной аутентификации.</p>
            <button id="totp-setup-submit" disabled type="submit" class="btn">Включить двухфакторную аутентификацию</button>
        </div>
    </form>

    <form id="disable-2fa">
        <div class="form-group">
            <p>Двухфакторная аутентификация активирована для вашей учётной записи<span id="mfa-device-label"></span>.</p>
            <p>После отключения двухфакторной аутентификации вам потребуется вновь войти в панель администратора.</p>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-danger">Отключить двухфакторную аутентификацию</button>
        </div>
    </form>

    <div id="output-2fa" class="panel panel-danger">
        <div class="panel-body"></div>
    </div>
</div>

<script>
    var el = {
        disableForm: document.getElementById('disable-2fa'),
        output: document.getElementById('output-2fa'),
        totpSetupForm: document.getElementById('totp-setup'),
        totpSetupToken: document.getElementById('totp-setup-token'),
        totpSetupSecret: document.getElementById('totp-setup-secret'),
        totpSetupLabel: document.getElementById('totp-setup-label'),
        totpQr: document.getElementById('totp-setup-qr'),
        totpSetupSubmit: document.querySelector('#totp-setup-submit'),
        wrapper: document.querySelector('.twofactor')
    }

    function update_setup_disabled(evt) {
        var val = evt.target.value.trim();

        if (
            typeof val !== 'string' ||
            typeof el.totpSetupSecret.value !== 'string' ||
            val.length !== 6 ||
            el.totpSetupSecret.value.length !== 32 ||
            !(/^\+?\d+$/.test(val))
        ) {
            el.totpSetupSubmit.setAttribute('disabled', '');
        } else {
            el.totpSetupSubmit.removeAttribute('disabled');
        }
    }

    function render_totp_setup(provisioned_totp) {
        var img = document.createElement('img');
        img.src = "data:image/png;base64," + provisioned_totp.qr_code_base64;

    var code = document.createElement('div');
    code.innerHTML = `Секрет: ${provisioned_totp.secret}`;

        el.totpQr.appendChild(img);
        el.totpQr.appendChild(code);

        el.totpSetupToken.addEventListener('input', update_setup_disabled);
        el.totpSetupForm.addEventListener('submit', do_enable_totp);

        el.totpSetupSecret.setAttribute('value', provisioned_totp.secret);

        el.wrapper.classList.add('disabled');
    }

    function render_disable(mfa) {
        el.disableForm.addEventListener('submit', do_disable);
        el.wrapper.classList.add('enabled');
                if (mfa.label)
                    $("#mfa-device-label").text(" на устройстве '" + mfa.label + "'");
    }

    function hide_error() {
        el.output.querySelector('.panel-body').innerHTML = '';
        el.output.classList.remove('visible');
    }

    function render_error(msg) {
        el.output.querySelector('.panel-body').innerHTML = msg;
        el.output.classList.add('visible');
    }

    function reset_view() {
        el.wrapper.classList.remove('loaded', 'disabled', 'enabled');

        el.disableForm.removeEventListener('submit', do_disable);

        hide_error();

        el.totpSetupForm.reset();
        el.totpSetupForm.removeEventListener('submit', do_enable_totp);

        el.totpSetupSecret.setAttribute('value', '');
        el.totpSetupToken.removeEventListener('input', update_setup_disabled);

        el.totpSetupSubmit.setAttribute('disabled', '');
        el.totpQr.innerHTML = '';
    }

    function show_mfa() {
        reset_view();

        api(
            '/mfa/status',
            'POST',
            {},
            function(res) {
                el.wrapper.classList.add('loaded');

                var has_mfa = false;
                res.enabled_mfa.forEach(function(mfa) {
                    if (mfa.type == "totp") {
                        render_disable(mfa);
                        has_mfa = true;
                    }
                });

                if (!has_mfa)
                  render_totp_setup(res.new_mfa.totp);
            }
        );
    }

    function do_disable(evt) {
        evt.preventDefault();
        hide_error();

        api(
            '/mfa/disable',
            'POST',
            { type: 'totp' },
            function() {
                do_logout();
            }
        );

        return false;
    }

    function do_enable_totp(evt) {
        evt.preventDefault();
        hide_error();

        api(
            '/mfa/totp/enable',
            'POST',
            {
                token: $(el.totpSetupToken).val(),
                secret: $(el.totpSetupSecret).val(),
                label: $(el.totpSetupLabel).val()
            },
            function(res) { do_logout(); },
            function(res) { render_error(res); }
        );

        return false;
    }
</script>
