<h2>Пользователи</h2>

<style>
#user_table tr.account_inactive td.address { color: #888; text-decoration: line-through; }
#user_table .actions { margin-top: .33em; font-size: 95%; }
#user_table .account_inactive .if_active { display: none; }
#user_table .account_active .if_inactive { display: none; }
#user_table .account_active.if_inactive { display: none; }
.row-center { text-align: center; }
</style>

<h3>Добавить почтового пользователя</h3>

<p>Добавьте адрес электронной почты в эту систему. Будет создан новый логин (имя пользователя) и пароль.</p>

<form class="form-inline" role="form" onsubmit="return do_add_user(); return false;">
  <div class="form-group">
  <label class="visually-hidden" for="adduserEmail">Адрес эл. почты</label>
  <input type="email" class="form-control" id="adduserEmail" placeholder="Адрес эл. почты">
  </div>
  <div class="form-group">
  <label class="visually-hidden" for="adduserPassword">Пароль</label>
  <input type="password" class="form-control" id="adduserPassword" placeholder="Пароль">
  </div>
  <div class="form-group">
    <select class="form-control" id="adduserPrivs">
  <option value="">Обычный пользователь</option>
  <option value="admin">Администратор</option>
    </select>
  </div>
  <div class="form-group">
  <label class="visually-hidden" for="adduserQuota">Квота</label>
  <input type="text" class="form-control" id="adduserQuota" placeholder="Квота" style="width:5em;" value="0">
  </div>
  <button type="submit" class="btn btn-primary">Добавить пользователя</button>
</form>
<ul style="margin-top: 1em; padding-left: 1.5em; font-size: 90%;">
  <li>Пароли должны содержать не менее восьми символов и состоять только из латинских букв и цифр. Для удобства <a href="#" onclick="return generate_random_password()">сгенерируйте случайный пароль</a>.</li>
  <li>Используйте <a href="#aliases">алиасы</a>, чтобы создавать адреса, пересылающие почту на существующие аккаунты.</li>
  <li>Администраторы получают доступ к этой панели управления.</li>
  <li>Имена пользователей не могут содержать символы вне ASCII, но <a href="#aliases">алиасы</a> могут.</li>
  <li>В квотах не допускаются пробелы, запятые или десятичные точки. Допускаются суффиксы G (гигабайты) и M (мегабайты). Для неограниченного объёма введите 0 (ноль).</li>
</ul>

<h3>Существующие почтовые пользователи</h3>
<table id="user_table" class="table" style="width: auto">
  <thead>
    <tr>
      <th width="35%">Адрес эл. почты</th>
      <th class="row-center">Размер</th>
      <th class="row-center">Использовано</th>
      <th class="row-center">Квота</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div style="display: none">
  <table>
  <tr id="user-template">
    <td class='address'>
    </td>
    <td class="box-size row-center"></td>
    <td class="percent row-center"></td>
	<td class="quota row-center">
	</td>
    <td class='actions'>
  <span class='privs'>
  </span>

        <span class="if_active">
      <a href="#" onclick="users_set_quota(this); return false;" class='setquota' title="Задать квоту">
        задать квоту
      </a>
          |
        </span>

        <span class="if_active">
          <a href="#" onclick="users_set_password(this); return false;" class='setpw' title="Задать пароль">
            задать пароль
          </a>
          |
        </span>

        <span class='add-privs'>
        </span>

        <a href="#" onclick="users_remove(this); return false;" class='if_active' title="Архивировать учётную запись">
          архивировать учётную запись
        </a>
    </td>
  </tr>
  <tr id="user-extra-template" class="if_inactive">
    <td colspan="3" style="border: 0; padding-top: 0">
      <div class='restore_info' style='color: #888; font-size: 90%'>Чтобы восстановить учётную запись, создайте новую учётную запись с этим адресом электронной почты. Чтобы окончательно удалить почтовый ящик, удалите каталог <tt></tt> на сервере.</div>
    </td>
  </tr>
  </table>
</div>

<h3>API пользователей почты (для продвинутых)</h3>

<p>Используйте API пользователей почты этого сервера для добавления/изменения/удаления учётных записей из командной строки или собственных сервисов.</p>

<p>Использование:</p>

<pre>curl -X <b>VERB</b> [-d "<b>parameters</b>"] --user {email}:{password} https://{{hostname}}/admin/mail/users[<b>action</b>]</pre>

<p>Квадратные скобки означают необязательный аргумент. Обратите внимание, что тело POST-запроса (<code>parameters</code>) должно быть URL-кодировано.</p>

<p>Параметры <code>--user</code> (email и пароль) должны принадлежать административному пользователю этой системы.</p>

<h4 style="margin-bottom: 0">HTTP-методы</h4>

<table class="table" style="margin-top: .5em">
<thead><th>Метод</th> <th>Действие</th><th></th></thead>
<tr><td>GET</td><td><i>(нет)</i></td> <td>Возвращает список существующих почтовых пользователей. Добавление <code>?format=json</code> к URL вернёт JSON-результат.</td></tr>
<tr>
  <td>POST</td>
  <td>/add</td>
  <td>Добавляет нового почтового пользователя. Обязательные параметры POST: <code>email</code> и <code>password</code>. Дополнительно: <code>privilege=admin</code> и <code>quota</code></td>
</tr>
<tr>
  <td>POST</td>
  <td>/remove</td>
  <td>Удаляет почтового пользователя. Обязательный параметр POST: <code>email</code>.</td>
</tr>
<tr><td>POST</td><td>/privileges/add</td> <td>Используется для назначения пользователю права администратора. Обязательные параметры POST: <code>email</code> и <code>privilege=admin</code>.</td></tr>
<tr><td>POST</td><td>/privileges/remove</td> <td>Используется для снятия права администратора с пользователя. Обязательный параметр POST: <code>email</code>.</td></tr>
<tr>
  <td>GET</td>
  <td>/quota</td>
  <td>Получить квоту пользователя. Обязательные параметры: <code>email</code>. Вернёт JSON.</td>
</tr>
<tr>
  <td>POST</td>
  <td>/quota</td>
  <td>Установить квоту для пользователя. Обязательные параметры POST: <code>email</code> и <code>quota</code>.</td>
</tr>
</table>

<h4>Примеры:</h4>

<p>Попробуйте эти примеры. Для простоты в примерах опущён аргумент командной строки <code>--user me@mydomain.com:yourpassword</code>, который вы должны заполнить своим административным email и паролем.</p>

<pre># Возвращает список пользователей в формате JSON
curl -X GET https://{{hostname}}/admin/mail/users?format=json

# Добавляет нового почтового пользователя
curl -X POST -d "email=new_user@mydomail.com" -d "password=s3curE_pa5Sw0rD" https://{{hostname}}/admin/mail/users/add

# Удаляет почтового пользователя
curl -X POST -d "email=new_user@mydomail.com" https://{{hostname}}/admin/mail/users/remove

# Выдаёт пользователю право администратора
curl -X POST -d "email=new_user@mydomail.com" -d "privilege=admin" https://{{hostname}}/admin/mail/users/privileges/add

# Снимает у пользователя право администратора
curl -X POST -d "email=new_user@mydomail.com" https://{{hostname}}/admin/mail/users/privileges/remove
</pre>

<script>
function show_users() {
  $('#user_table tbody').html("<tr><td colspan='2' class='text-muted'>Загрузка...</td></tr>")
  api(
    "/mail/users",
    "GET",
    { format: 'json' },
    function(r) {
      $('#user_table tbody').html("");
      for (var i = 0; i < r.length; i++) {
        var hdr = $("<tr><th colspan='6' style='background-color: #EEE'></th></tr>");
        hdr.find('th').text(r[i].domain);
        $('#user_table tbody').append(hdr);

        for (var k = 0; k < r[i].users.length; k++) {
          var user = r[i].users[k];

          var n = $("#user-template").clone();
          var n2 = $("#user-extra-template").clone();
          n.attr('id', '');
          n2.attr('id', '');
          $('#user_table tbody').append(n);
          $('#user_table tbody').append(n2);

          n.addClass("account_" + user.status);
          n2.addClass("account_" + user.status);

          n.attr('data-email', user.email);
          n.attr('data-quota', user.quota);
          n.find('.address').text(user.email);
          n.find('.box-size').text(user.box_size);
          if (user.box_size == '?') {
            n.find('.box-size').attr('title', 'Размер почтового ящика неизвестен')
          }
          n.find('.percent').text(user.percent);
          n.find('.quota').text((user.quota == '0') ? 'неограничено' : user.quota);
          n2.find('.restore_info tt').text(user.mailbox);

          if (user.status == 'inactive') continue;

          var add_privs = ["admin"];

          for (var j = 0; j < user.privileges.length; j++) {
            var p = $("<span><b><span class='name'></span></b> (<a href='#' onclick='mod_priv(this, \"remove\"); return false;' title='Удалить привилегию'>удалить привилегию</a>) |</span>");
            p.find('span.name').text(user.privileges[j]);
            n.find('.privs').append(p);
            if (add_privs.indexOf(user.privileges[j]) >= 0)
              add_privs.splice(add_privs.indexOf(user.privileges[j]), 1);
          }

          for (var j = 0; j < add_privs.length; j++) {
            var p = $("<span><a href='#' onclick='mod_priv(this, \"add\"); return false;' title='Добавить привилегию'>назначить <span class='name'></span></a> | </span>");
            p.find('span.name').text(add_privs[j]);
            n.find('.add-privs').append(p);
          }
        }
      }
    })
}

function do_add_user() {
  var email = $("#adduserEmail").val();
  var pw = $("#adduserPassword").val();
  var privs = $("#adduserPrivs").val();
  var quota = $("#adduserQuota").val();
  api(
    "/mail/users/add",
    "POST",
    {
      email: email,
      password: pw,
      privileges: privs,
      quota: quota
    },
    function(r) {
      // Responses are multiple lines of pre-formatted text.
      show_modal_error("Добавить пользователя", $("<pre/>").text(r));
      show_users()
    },
    function(r) {
      show_modal_error("Добавить пользователя", r);
    });
  return false;
}

function users_set_password(elem) {
  var email = $(elem).parents('tr').attr('data-email');

  var yourpw = "";
  if (api_credentials != null && email == api_credentials.username)
    yourpw = "<p class='text-danger'>Если вы измените свой собственный пароль, вы будете выведены из панели управления и вам потребуется войти снова.</p>";

  show_modal_confirm(
    "Задать пароль",
    $("<p>Задать новый пароль для <b>" + email + "</b>?</p> <p><label for='users_set_password_pw' style='display: block; font-weight: normal'>Новый пароль:</label><input type='password' id='users_set_password_pw'></p><p><small>Пароли должны содержать не менее восьми символов и не содержать пробелов.</small>" + yourpw + "</p>"),
    "Задать пароль",
    function() {
      api(
        "/mail/users/password",
        "POST",
        {
          email: email,
          password: $('#users_set_password_pw').val()
        },
        function(r) {
          // Responses are multiple lines of pre-formatted text.
          show_modal_error("Задать пароль", $("<pre/>").text(r));
        },
        function(r) {
          show_modal_error("Задать пароль", r);
        });
    });
}

function users_set_quota(elem) {
    var email = $(elem).parents('tr').attr('data-email');
    var quota = $(elem).parents('tr').attr('data-quota');

  show_modal_confirm(
    "Задать квоту",
    $("<p>Задать квоту для <b>" + email + "</b>?</p>" +
      "<p>" +
      "<label for='users_set_quota' style='display: block; font-weight: normal'>Квота:</label>" +
      "<input type='text' id='users_set_quota' value='" + quota + "'></p>" +
      "<p><small>В квотах не допускаются пробелы или запятые. Допускаются суффиксы G (гигабайты) и M (мегабайты).</small></p>" +
      "<p><small>Для неограниченного объёма введите 0 (ноль)</small></p>"),
    "Задать квоту",
        function() {
            api(
                "/mail/users/quota",
                "POST",
                {
                    email: email,
                    quota: $('#users_set_quota').val()
                },
                function(r) {
                    show_users();
                },
                function(r) {
        show_modal_error("Задать квоту", r);
                });
        });
}

function users_remove(elem) {
  var email = $(elem).parents('tr').attr('data-email');

  // can't remove yourself
  if (api_credentials != null && email == api_credentials.username) {
    show_modal_error("Архивирование пользователя", "Вы не можете архивировать свою собственную учётную запись.");
    return;
  }

  show_modal_confirm(
    "Архивировать пользователя",
    $("<p>Вы уверены, что хотите архивировать <b>" + email + "</b>?</p> <p>Почтовые ящики пользователя при этом не будут удалены (вы сможете удалить их позже), но пользователь больше не сможет войти в сервисы на этом сервере.</p>"),
    "Архивировать",
    function() {
      api(
        "/mail/users/remove",
        "POST",
        {
          email: email
        },
        function(r) {
          // Responses are multiple lines of pre-formatted text.
          show_modal_error("Удалить пользователя", $("<pre/>").text(r));
          show_users();
        },
        function(r) {
          show_modal_error("Удалить пользователя", r);
        });
    });
}

function mod_priv(elem, add_remove) {
  var email = $(elem).parents('tr').attr('data-email');
  var priv = $(elem).parents('td').find('.name').text();

  // can't remove your own admin access
  if (priv == "admin" && add_remove == "remove" && api_credentials != null && email == api_credentials.username) {
    show_modal_error("Изменить привилегии", "Вы не можете снять у себя привилегию администратора.");
    return;
  }

  var add_remove1 = add_remove.charAt(0).toUpperCase() + add_remove.substring(1);
  var add_remove1_local = (add_remove == 'add') ? 'Добавить' : 'Удалить';
  show_modal_confirm(
    "Изменить привилегии",
    $("<p>Вы уверены, что хотите " + (add_remove == 'add' ? 'добавить' : 'удалить') + " привилегию " + priv + " для <b>" + email + "</b>?</p>"),
    add_remove1_local,
    function() {
      api(
        "/mail/users/privileges/" + add_remove,
        "POST",
        {
          email: email,
          privilege: priv
        },
        function(r) {
          show_users();
        });
    });
}

function generate_random_password() {
  var pw = "";
  var charset = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789"; // confusable characters skipped
  for (var i = 0; i < 12; i++)
    pw += charset.charAt(Math.floor(Math.random() * charset.length));
  show_modal_error("Случайный пароль", "<p>Попробуйте этот пароль:</p> <p><code style='font-size: 110%'>" + pw + "</code></p>");
  return false; // cancel click
}
</script>
