<style>
</style>

<h2>TLS (SSL) сертификаты</h2>

<p>TLS (ранее SSL) — это криптографический сертификат, который подтверждает, что соединение между посетителем и владельцем сайта защищено.</p>

<p>Вам нужен TLS‑сертификат для имени этого сервера ({{hostname}}) и для каждого домена и поддомена, для которых этот сервер обслуживает веб‑сайт (см. список ниже).</p>

<div id="ssl_provision">
<h3>Получение сертификатов</h3>

<div id="ssl_provision_p" style="display: none; margin-top: 1.5em">
  <button onclick='return provision_tls_cert();' class='btn btn-primary' style="float: left; margin: 0 1.5em 1em 0;">Получить сертификат</button>
  <p>TLS‑сертификат можно автоматически получить у <a href="https://letsencrypt.org/" target="_blank">Let&rsquo;s Encrypt</a> (бесплатный поставщик) для:<br>
  <span class="text-primary"></span></p>
</div>

<div class="clearfix"> </div>

<div id="ssl_provision_result"></div>
</div>

<h3>Статус сертификатов</h3>

<p style="margin-top: 1.5em">Сертификаты действительны ограниченный период. Все сертификаты автоматически обновляются через <a href="https://letsencrypt.org/" target="_blank">Let&rsquo;s Encrypt</a> за 14 дней до истечения срока.</p>

<table id="ssl_domains" class="table" style="margin-bottom: 2em; width: auto; display: none">
  <thead>
    <tr>
  <th>Домен</th>
  <th>Статус сертификата</th>
  <th>Действия</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>


<h3 id="ssl_install_header">Установка сертификата</h3>

<p>Если вы не хотите пользоваться автоматической интеграцией с Let's Encrypt, вы можете получить сертификат у любого другого поставщика. Ниже можно сгенерировать CSR (запрос на подпись сертификата).</p>

<p>Для какого домена вы запрашиваете сертификат?</p>

<p><select id="ssldomain" onchange="show_csr()" class="form-control" style="width: auto"></select></p>

<p>(Мультидоменный или wildcard‑сертификат будет автоматически применён ко всем доменам, для которых он действителен, помимо выбранного выше.)</p>

<p>В какой вы стране? Некоторые поставщики сертификатов требуют эту информацию. Оставьте поле пустым, если ваш поставщик не требует её.</p>

<p><select id="sslcc" onchange="show_csr()" class="form-control" style="width: auto">
  <option value="">(Выбрать)</option>
  {% for code, name in csr_country_codes %}
    <option value="{{code}}">{{name}}</option>
  {% endfor %}
</select></p>

<div id="csr_info" style="display: none">
  <p>Предоставьте поставщику следующий CSR (Certificate Signing Request):</p>

  <pre id="ssl_csr"></pre>

  <p><small>CSR можно безопасно передавать — он используется вместе с приватным ключом, хранящимся на этой машине.</small></p>

  <p>Поставщик выдаст вам TLS/SSL сертификат. Также он может предоставить промежуточную цепочку сертификатов. Вставьте их по отдельности в поля ниже:</p>

  <p style="margin-bottom: .5em">TLS/SSL сертификат:</p>
  <p><textarea id="ssl_paste_cert" class="form-control" style="max-width: 40em; height: 8em" placeholder="-----BEGIN CERTIFICATE-----&#xA;stuff here&#xA;-----END CERTIFICATE-----"></textarea></p>

  <p style="margin-bottom: .5em">Промежуточная цепочка TLS/SSL (если предоставлена):</p>
  <p><textarea id="ssl_paste_chain" class="form-control" style="max-width: 40em; height: 8em" placeholder="-----BEGIN CERTIFICATE-----&#xA;stuff here&#xA;-----END CERTIFICATE-----&#xA;-----BEGIN CERTIFICATE-----&#xA;more stuff here&#xA;-----END CERTIFICATE-----"></textarea></p>

  <p>После вставки информации нажмите кнопку установки.</p>

  <button class="btn-primary" onclick="install_cert()">Установить</button>
</div>

<script>
function show_tls(keep_provisioning_shown) {
 api(
    "/ssl/status",
    "GET",
    {
    },
    function(res) {
      // provisioning status

      if (!keep_provisioning_shown)
        $('#ssl_provision').toggle(res.can_provision.length > 0)

      $('#ssl_provision_p').toggle(res.can_provision.length > 0);
      if (res.can_provision.length > 0)
          $('#ssl_provision_p span').text(res.can_provision.join(", "));

      // certificate status
      var domains = res.status;
      var tb = $('#ssl_domains tbody');
      tb.text('');
      $('#ssldomain').html('<option value="">(select)</option>');
      $('#ssl_domains').show();
      for (var i = 0; i < domains.length; i++) {
  var row = $("<tr><th class='domain'><a href=''></a></th><td class='status'></td> <td class='actions'><a href='#' onclick='return ssl_install(this);' class='btn btn-xs'>Установить сертификат</a></td></tr>");
        tb.append(row);
        row.attr('data-domain', domains[i].domain);
        row.find('.domain a').text(domains[i].domain);
        row.find('.domain a').attr('href', 'https://' + domains[i].domain);
        if (domains[i].status == "not-applicable") {
          domains[i].status = "muted"; // text-muted css class
          row.find('.actions a').remove(); // no actions applicable
        }
        row.addClass("text-" + domains[i].status);
        row.find('.status').text(domains[i].text);
        if (domains[i].status == "success") {
          row.find('.actions a').addClass('btn-default').text('Заменить сертификат');
        } else {
          row.find('.actions a').addClass('btn-primary').text('Установить сертификат');
        }

        $('#ssldomain').append($('<option>').text(domains[i].domain));
      }
    });
}

function ssl_install(elem) {
  var domain = $(elem).parents('tr').attr('data-domain');
  $('#ssldomain').val(domain);
  show_csr();
  $('html, body').animate({ scrollTop: $('#ssl_install_header').offset().top - $('.navbar-fixed-top').height() - 20 })
  return false;
}

function show_csr() {
 // Can't show a CSR until both inputs are entered.
 if ($('#ssldomain').val() == "") return;
 if ($('#sslcc').val() == "") return;

 // Scroll to it and fetch.
 $('#csr_info').slideDown();
  $('#ssl_csr').text('Загрузка...');
 api(
    "/ssl/csr/" + $('#ssldomain').val(),
    "POST",
    {
        countrycode: $('#sslcc').val()
    },
    function(data) {
      $('#ssl_csr').text(data);
    });
}

function install_cert() {
 api(
    "/ssl/install",
    "POST",
    {
      domain: $('#ssldomain').val(),
      cert: $('#ssl_paste_cert').val(),
      chain: $('#ssl_paste_chain').val()
    },
    function(status) {
      if (/^OK($|\n)/.test(status)) {
        console.log(status)
        show_modal_error("Установка TLS‑сертификата", "Сертификат установлен. Проверьте доступность домена без ошибок соединения.", function() { show_ssl(); $('#csr_info').slideUp(); });
      } else {
        show_modal_error("Установка TLS‑сертификата", status);
      }
    });
}

function provision_tls_cert() {
  // Automatically provision any certs.
  $('#ssl_provision_p .btn').attr('disabled', '1'); // prevent double-clicks
  api(
    "/ssl/provision",
    "POST",
    { },
    function(status) {
      // Clear last attempt.
      $('#ssl_provision_result').text("");
      may_reenable_provision_button = true;

      // Nothing was done. There might also be problem domains, but we've already displayed those.
      if (status.requests.length == 0) {
        show_modal_error("Получение TLS‑сертификатов", "Нет доменных имён, для которых можно получить сертификаты.");
        // don't return - haven't re-enabled the provision button
      }

      // Each provisioning API call returns zero or more "requests" which represent
      // a request to Let's Encrypt for a single certificate. Normally there is just
      // one request (for a single multi-domain certificate).
      for (var i = 0; i < status.requests.length; i++) {
        var r = status.requests[i];

        if (r.result == "skipped") {
          // not interested --- this domain wasn't in the table
          // to begin with
          continue;
        }

        // create an HTML block to display the results of this request
        var n = $("<div><h4/><p/></div>");
        $('#ssl_provision_result').append(n);

        // plain log line
        if (typeof r === "string") {
          n.find("p").text(r);
          continue;
        }

        // show a header only to disambiguate request blocks
        if (status.requests.length > 0)
          n.find("h4").text(r.domains.join(", "));

        if (r.result == "error") {
          n.find("p").addClass("text-danger").text(r.message);

        } else if (r.result == "installed") {
          n.find("p").addClass("text-success").text("TLS‑сертификат был получен и установлен.");
          setTimeout("show_tls(true)", 1); // update main table of certificate statuses, call with arg keep_provisioning_shown true so that we don't clear what we just outputted

        }

        // display the detailed log info in case of problems
  var trace = $("<div class='small text-muted' style='margin-top: 1.5em'>Журнал:</div>");
        n.append(trace);
        for (var j = 0; j < r.log.length; j++)
          trace.append($("<div/>").text(r.log[j]));
      }

      if (may_reenable_provision_button)
        $('#ssl_provision_p .btn').removeAttr("disabled");
    });
}
</script>
