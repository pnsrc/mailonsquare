<style>
#alias_table .actions > * { padding-right: 3px; }
#alias_table .alias-auto .actions > * { display: none }
</style>

<h2>Псевдонимы</h2>

<h3>Добавить почтовый алиас</h3>

<p>Алиасы — это перенаправители электронной почты. Алиас может пересылать письма на <a href="#users">почтового пользователя</a> или на любой адрес электронной почты.</p>

<p>Чтобы использовать алиас или любой адрес, отличный от имени вашей учётной записи при отправке исходящей почты, отправитель должен быть включён в список разрешённых отправителей для этого алиаса.</p>

<form id="addalias-form" class="form-horizontal" role="form" onsubmit="do_add_alias(); return false;">
  <div class="form-group">
    <div class="col-sm-offset-1 col-sm-11">
      <div id="alias_type_buttons" class="btn-group btn-group-xs">
        <button type="button" class="btn btn-default" data-mode="regular">Обычный</button>
        <button type="button" class="btn btn-default" data-mode="catchall">Перехват (catch-all)</button>
        <button type="button" class="btn btn-default" data-mode="domainalias">Алиас домена</button>
      </div>
      <div id="alias_mode_info" class="text-info small" style="display: none; margin: .5em 0 0 0;">
        <span class="catchall hidden">Catch-all алиас перехватывает все письма, не совпавшие с другими адресами домена.</span>
        <span class="domainalias hidden">Алиас домена пересылает все непривязанные письма с одного домена на другой, сохраняя часть до символа @.</span>
      </div>
    </div>
  </div>
  <div class="form-group">
  <label for="addaliasAddress" class="col-sm-1 control-label">Алиас</label>
    <div class="col-sm-10">
      <input type="email" class="form-control" id="addaliasAddress">
      <div style="margin-top: 3px; padding-left: 3px; font-size: 90%" class="text-muted">
        <span class="catchall domainalias">Введите только часть адреса, начинающуюся с символа @.</span>
        Разрешены международные (не-ASCII) символы только в доменной части адреса.
      </div>
    </div>
  </div>
  <div class="form-group">
  <label for="addaliasForwardsTo" class="col-sm-1 control-label">Пересылать на</label>
    <div class="col-sm-10">
      <textarea class="form-control" rows="3" id="addaliasForwardsTo"></textarea>
      <div style="margin-top: 3px; padding-left: 3px; font-size: 90%">
        <span class="domainalias text-muted">Введите только часть адреса, начинающуюся с символа @.</span>
        <span class="text-danger">Пересылайте почту только на адреса, обслуживаемые этим Mail-in-a-Box — пересылка алиасами на внешние домены может быть отклонена или отфильтрована приёмником. Чтобы пересылать почту на другие домены, создайте почтового пользователя и настройте пересылку через фильтр в веб‑почте для этого пользователя.</span>
      </div>
    </div>
  </div>
  <div class="form-group">
  <label for="addaliasSenders" class="col-sm-1 control-label">Разрешённые отправители</label>
    <div class="col-sm-10">
      <div class="radio">
        <label>
          <input id="addaliasForwardsToNotAdvanced" name="addaliasForwardsToDivToggle" type="radio" checked onclick="$('#addaliasForwardsToDiv').toggle(false)">
          Любой почтовый пользователь, указанный в поле «Пересылать на», может отправлять письма, выдаваясь за <span class="regularalias">адрес алиаса</span><span class="catchall domainalias">любой адрес домена алиаса</span>.
        </label>
      </div>
      <div class="radio">
        <label>
          <input id="addaliasForwardsToAdvanced" name="addaliasForwardsToDivToggle" type="radio" id="addaliasForwardsToDivShower" onclick="$('#addaliasForwardsToDiv').toggle(true)">
          Я укажу почтовых пользователей, которые могут отправлять письма, выдаваясь за <span class="regularalias">адрес алиаса</span><span class="catchall domainalias">любой адрес домена алиаса</span>.
        </label>
      </div>
      <div id="addaliasForwardsToDiv" style="margin-top: .5em; margin-left: 1.4em; display: none;">
  <textarea class="form-control" rows="3" id="addaliasSenders" placeholder="один пользователь в строке или через запятую"></textarea>
      </div>
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-1 col-sm-11">
  <button id="add-alias-button" type="submit" class="btn btn-primary">Добавить алиас</button>
  <button id="alias-cancel" class="btn btn-default hidden" onclick="aliases_reset_form(); return false;">Отмена</button>
    </div>
  </div>
</form>

<h3>Существующие почтовые алиасы</h3>
<table id="alias_table" class="table" style="width: auto">
  <thead>
    <tr>
      <th></th>
      <th>Алиас<br></th>
      <th>Пересылать на</th>
      <th>Разрешённые отправители</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<p style="margin-top: 1.5em"><small>Адреса hostmaster@, postmaster@, admin@ и abuse@ требуются на некоторых доменах.</small></p>

  <div style="display: none">
  <table>
  <tr id="alias-template">
    <td class='actions'>
        <a href="#" onclick="aliases_edit(this); scroll_top(); return false;" class='edit' title="Редактировать алиас">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
        <a href="#" onclick="aliases_remove(this); return false;" class='remove' title="Удалить алиас">
          <span class="glyphicon glyphicon-trash"></span>
        </a>
    </td>
    <td class='address'> </td>
    <td class='forwardsTo'> </td>
    <td class='senders'> </td>
  </tr>
  </table>
</div>

<h3>API почтовых алиасов (для продвинутых)</h3>

<p>Используйте API почтовых алиасов вашего сервера для добавления и удаления алиасов из командной строки или собственных сервисов.</p>

<p>Использование:</p>

<pre>curl -X <b>VERB</b> [-d "<b>parameters</b>"] --user {email}:{password} https://{{hostname}}/admin/mail/aliases[<b>action</b>]</pre>

<p>Квадратные скобки обозначают необязательный аргумент. Обратите внимание, что тело POST-запроса <code>parameters</code> должно быть URL-кодировано.</p>

<p>Адрес электронной почты и пароль, переданные в опции <code>--user</code>, должны принадлежать административному пользователю на этой системе.</p>

<h4 style="margin-bottom: 0">HTTP-методы</h4>

<table class="table" style="margin-top: .5em">
<thead><th>Метод</th> <th>Действие</th><th></th></thead>
<tr><td>GET</td><td><i>(нет)</i></td> <td>Возвращает список существующих почтовых алиасов. Добавление <code>?format=json</code> к URL вернёт результат в формате JSON.</td></tr>
<tr><td>POST</td><td>/add</td> <td>Добавляет новый почтовый алиас. Обязательные параметры в теле POST: <code>address</code> и <code>forwards_to</code>.</td></tr>
<tr><td>POST</td><td>/remove</td> <td>Удаляет почтовый алиас. Обязательный параметр в теле POST: <code>address</code>.</td></tr>
</table>

<h4>Примеры:</h4>

<p>Попробуйте эти примеры. Для простоты примеры опускают аргумент командной строки <code>--user me@mydomain.com:yourpassword</code>, который вы должны заменить на ваш адрес электронной почты и пароль.</p>

<pre># Возвращает список всех почтовых алиасов в формате JSON
curl -X GET https://{{hostname}}/admin/mail/aliases?format=json

# Добавляет новый алиас
curl -X POST -d "address=new_alias@mydomail.com" -d "forwards_to=my_email@mydomain.com" https://{{hostname}}/admin/mail/aliases/add

# Удаляет алиас
curl -X POST -d "address=new_alias@mydomail.com" https://{{hostname}}/admin/mail/aliases/remove
</pre>


<script>
function show_aliases() {
  $('#alias_table tbody').html("<tr><td colspan='2' class='text-muted'>Загрузка...</td></tr>")
  api(
    "/mail/aliases",
    "GET",
    { format: 'json' },
    function(r) {
      $('#alias_table tbody').html("");
      for (var i = 0; i < r.length; i++) {
        var hdr = $("<tr><th colspan='4' style='background-color: #EEE'></th></tr>");
        hdr.find('th').text(r[i].domain);
        $('#alias_table tbody').append(hdr);

        for (var k = 0; k < r[i].aliases.length; k++) {
          var alias = r[i].aliases[k];

          var n = $("#alias-template").clone();
          n.attr('id', '');

          if (alias.auto) n.addClass('alias-auto');
          n.attr('data-address', alias.address_display); // this is decoded from IDNA, but will get re-coded to IDNA on the backend
          n.find('td.address').text(alias.address_display)
          for (var j = 0; j < alias.forwards_to.length; j++)
            n.find('td.forwardsTo').append($("<div></div>").text(alias.forwards_to[j]))
          for (var j = 0; j < (alias.permitted_senders ? alias.permitted_senders.length : 0); j++)
            n.find('td.senders').append($("<div></div>").text(alias.permitted_senders[j]))
          $('#alias_table tbody').append(n);
        }
      }
    })

  $(function() {
    $('#alias_type_buttons button').off('click').click(function() {
      $('#alias_type_buttons button').removeClass('active');
      $(this).addClass('active');
      $('#addalias-form .regularalias, #addalias-form .catchall, #addalias-form .domainalias').addClass('hidden');
        if ($(this).attr('data-mode') == "regular") {
        $('#addaliasAddress').attr('type', 'email');
        $('#addaliasAddress').attr('placeholder', 'you@yourdomain.com (входящий адрес электронной почты)');
        $('#addaliasForwardsTo').attr('placeholder', 'один адрес в строке или через запятую');
        $('#alias_mode_info').slideUp();
        $('#addalias-form .regularalias').removeClass('hidden');
      } else if ($(this).attr('data-mode') == "catchall") {
        $('#addaliasAddress').attr('type', 'text');
        $('#addaliasAddress').attr('placeholder', '@yourdomain.com (перехватывает все непривязанные адреса домена)');
        $('#addaliasForwardsTo').attr('placeholder', 'один адрес в строке или через запятую');
        $('#alias_mode_info').slideDown();
        $('#addalias-form .catchall').removeClass('hidden');
      } else if ($(this).attr('data-mode') == "domainalias") {
        $('#addaliasAddress').attr('type', 'text');
        $('#addaliasAddress').attr('placeholder', '@yourdomain.com (перехватывает все непривязанные адреса домена)');
        $('#addaliasForwardsTo').attr('placeholder', '@otherdomain.com (пересылать на другой домен)');
        $('#alias_mode_info').slideDown();
        $('#addalias-form .domainalias').removeClass('hidden');
      }
    })
    $('#alias_type_buttons button[data-mode="regular"]').click(); // init
  })
}

var is_alias_add_update = false;
function do_add_alias() {
  var title = (!is_alias_add_update) ? "Добавить алиас" : "Обновить алиас";
  var form_address = $("#addaliasAddress").val();
  var form_forwardsto = $("#addaliasForwardsTo").val();
  var form_senders = ($('#addaliasForwardsToAdvanced').prop('checked') ? $("#addaliasSenders").val() : '');
    if ($('#addaliasForwardsToAdvanced').prop('checked') && !/\S/.exec($("#addaliasSenders").val())) {
    show_modal_error(title, "Вы не указали ни одного разрешённого отправителя.");
    return false;
  }
  api(
    "/mail/aliases/add",
    "POST",
    {
      update_if_exists: is_alias_add_update ? '1' : '0',
      address: form_address,
      forwards_to: form_forwardsto,
      permitted_senders: form_senders
    },
    function(r) {
      // Responses are multiple lines of pre-formatted text.
      show_modal_error(title, $("<pre/>").text(r));
      show_aliases()
      aliases_reset_form();
    },
    function(r) {
      show_modal_error(title, r);
    });
  return false;
}

function aliases_reset_form() {
  $("#addaliasAddress").prop('disabled', false);
  $("#addaliasAddress").val('')
  $("#addaliasForwardsTo").val('')
  $("#addaliasSenders").val('')
  $('#alias-cancel').addClass('hidden');
  $('#add-alias-button').text('Добавить алиас');
  is_alias_add_update = false;
}

function aliases_edit(elem) {
  var address = $(elem).parents('tr').attr('data-address');
  var receiverdivs = $(elem).parents('tr').find('.forwardsTo div');
  var senderdivs = $(elem).parents('tr').find('.senders div');
  var forwardsTo = "";
  for (var i = 0; i < receiverdivs.length; i++)
    forwardsTo += $(receiverdivs[i]).text() + "\n";
  var senders = "";
  for (var i = 0; i < senderdivs.length; i++)
    senders += $(senderdivs[i]).text() + "\n";
  if (address.charAt(0) == '@' && forwardsTo.charAt(0) == '@')
    $('#alias_type_buttons button[data-mode="domainalias"]').click();
  else if (address.charAt(0) == '@')
    $('#alias_type_buttons button[data-mode="catchall"]').click();
  else
    $('#alias_type_buttons button[data-mode="regular"]').click();
  $('#alias-cancel').removeClass('hidden');
  $("#addaliasAddress").prop('disabled', true);
  $("#addaliasAddress").val(address);
  $("#addaliasForwardsTo").val(forwardsTo);
  $('#addaliasForwardsToAdvanced').prop('checked', senders != "");
  $('#addaliasForwardsToNotAdvanced').prop('checked', senders == "");
  $("#addaliasSenders").val(senders);
  $('#add-alias-button').text('Обновить');
  $('body').animate({ scrollTop: 0 })
  is_alias_add_update = true;
}

function aliases_remove(elem) {
  var row_address = $(elem).parents('tr').attr('data-address');
  show_modal_confirm(
    "Удалить алиас",
    "Удалить " + row_address + "?",
    "Удалить",
    function() {
      api(
        "/mail/aliases/remove",
        "POST",
        {
          address: row_address
        },
        function(r) {
          // Responses are multiple lines of pre-formatted text.
          show_modal_error("Удалить алиас", $("<pre/>").text(r));
          show_aliases();
        });
    });
}

function scroll_top() {
        $('html, body').animate({
            scrollTop: $("#panel_aliases").offset().top
        }, 1000);
}
</script>
